<!DOCTYPE html>
<html>
<head>
   <title>Моя статья</title>
   <link rel="stylesheet" type="text/css" href="styles.css">
</head>
<style>
body {
   background-color: #f0f0f0;
   font-family: Arial, sans-serif;
}

header {
   background-color: #333;
   color: white;
   padding: 10px;
   text-align: center;
}

h1 {
   margin: 0;
}

article {
   margin: 20px;
}

h2 {
   color: #333;
}

p {
   line-height: 1.6;
}
</style>
<body>
   <header>
       <h1>статья</h1>
   </header>
   <article>
       <p>
уровневой организации, изображенной на рис . 29 .1 . Внизу находится уро-

вень оборудования . Как предупреждает Дуг, вследствие совершенствования 

технологий и согласно закону Мура оборудование будет изменяться . Одни 

компоненты устаревают, и на смену им приходят новые компоненты, по-

требляющие меньше электроэнергии, или имеющие более высокую произ-

водительность, или стоящие дешевле . Независимо от причин я, как инженер 

встраиваемых систем, не хотел бы делать больше, чем необходимо, когда 

неизбежное изменение оборудования наконец произойдет .

Программное

обеспечение

Микропрограмма

Оборудование

Рис. 29.1. Три уровня

Раздел между оборудованием и остальной частью системы — объективная 

реальность, по крайней мере после определения оборудования (рис . 29 .2) . 

Именно здесь часто возникают проблемы при попытке пройти тест на проф-

пригодность . Ничто не мешает знаниям об оборудовании инфицировать 

весь код . Если не проявить осторожность при структурировании кода и не 

ограничить просачивание сведений об одном модуле в другой, код будет 

трудно изменить . Я говорю не только о случае, когда изменяется оборудова-

ние, но также о ситуации, когда понадобится исправить ошибку или внести 

изменение по требованию пользователя .

Привязка к оборудованию — узкое место      255

Микро-

программа

Оборудование

Рис. 29.2. Оборудование должно отделяться от остальной системы

Смешивание программного обеспечения и микропрограмм — это антиша-

блон . Код, демонстрирующий этот антишаблон, будет сопротивляться изме-

нениям . Кроме того, изменения сопряжены с опасностями, часто ведущими 

к непредвиденным последствиям . Даже незначительные изменения требуют 

полного регрессионного тестирования системы . Если вы не создали тесты 

с внешним оборудованием, готовьтесь проводить тестирование вручную, 

а затем ожидать новых сообщений об обнаруженных ошибках .

Оборудование — это деталь

Линия между программным обеспечением и микропрограммами обычно 

видна не так четко, как линия, разделяющая код и оборудование (рис . 29 .3) .

Одна из задач разработчика встраиваемого программного обеспечения — 

укрепить эту линию . Границу между программным обеспечением и микро-

Программное

обеспечение

Микро-

программа

Оборудование

Рис. 29.3. Линия между программным обеспечением и микропрограммами обычно 

более размытая, чем линия между кодом и оборудованием

256   Глава 29. Чистая встраиваемая архитектура

программой (рис . 29 .4) называют слоем аппаратных абстракций (Hardware 

Abstraction Layer; HAL) . Это не новая идея: она была реализована в персо-

нальных компьютерах еще в эпоху до Windows .

Программное

обеспечение

Микро-

программа

Оборудование

Рис. 29.4. Слой аппаратных абстракций

Слой HAL существует для программного обеспечения над ним, и его API 

должен приспосабливаться под потребности этого программного обеспече-

ния . Например, микропрограмма может хранить байты и массивы байтов 

во флеш-памяти, а приложению требуется хранить и читать пары имя/

значение с использованием некоторого механизма хранения . Программное 

обеспечение не должно заботиться о деталях хранения пар имя/значение 

во флеш-памяти, на вращающемся диске, в облаке или в основной памяти . 

Слой аппаратных абстракций (HAL) предоставляет услугу и не раскрыва-

ет программному обеспечению, как она работает . Реализация поддержки 

флеш-памяти — это деталь, которая должна быть скрыта от программного 

обеспечения .

Еще один пример: управление светодиодом привязано к биту GPIO1 . Ми-

кропрограмма может предоставлять доступ к битам GPIO, а слой HAL 

может иметь функцию Led_TurnOn(5) . Это довольно низкоуровневый слой 

аппаратной абстракции . Давайте посмотрим, как повысить уровень абстрак-

ции с точки зрения программного обеспечения/продукта . Какую информа-

цию сообщает светодиод? Допустим, что включение светодиода сообщает 

о низком заряде аккумулятора . На некотором уровне микропрограмма (или 

пакет поддержки платформы) может предоставлять функцию Led_TurnOn(5), 

а слой HAL — функцию Indicate_LowBattery() . Таким способом слой HAL 

выражает назначение услуги для приложения . Кроме того, уровни могут 

содержать подуровни . Это больше напоминает повторяющийся фракталь-

1 General-Purpose Input/Output (интерфейс ввода/вывода общего назначения) . — При-

меч. пер.

Привязка к оборудованию — узкое место      257

ный узор, чем ограниченный набор предопределенных уровней . Назначение 

ввода/выводов GPIO — это детали, которые должны быть скрыты от про-

граммного обеспечения .

Не раскрывайте деталей об оборудовании 

пользователям HAL

Встраиваемое программное обеспечение с чистой архитектурой допускает 

возможность тестирования без целевого оборудования . Удачно спроек-

тированный слой аппаратных абстракций (HAL) предоставляет тот шов, 

или набор, точек подстановки, которые облегчат тестирование без обо-

рудования .

Процессор — это деталь

Когда сборка встраиваемого программного обеспечения производится с при-

менением специализированного набора инструментов, в комплект часто 

входят заголовочные файлы с <i>поддержкой дополнительных конструкций 

</i>1 . Эти компиляторы часто допускают вольное обращение с языком C, 

добавляя новые ключевые слова для доступа к функциям процессора . Код 

выглядит как код на C, но он больше не является кодом на C .

Иногда компиляторы языка C, поставляемые производителем оборудова-

ния, поддерживают нечто, напоминающее глобальные переменные, дающие 

</p>
   </article>
</body>
</html>
